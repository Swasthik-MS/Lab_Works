<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eQLM Plant Dashboard Prototype</title>
    
    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* -------------------------
         * Global Resets & Setup
         * ------------------------- */
        :root {
            --primary-blue: #4A65E2; /* A fresh, modern blue */
            --primary-hover: #4058C3;
            --sidebar-bg: #ffffff;
            --content-bg: #f7f8fa;
            --header-bg: #ffffff;
            --border-color: #e9ecef;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-on-primary: #ffffff;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 88px; /* 80px + 8px padding */
            --header-height: 65px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--content-bg);
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-primary);
        }

        /* -------------------------
         * Toast Notification (New)
         * ------------------------- */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745; /* Success green */
            color: #ffffff;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 9999;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }
        .toast-notification.warning {
            background-color: #ffc107; /* Warning yellow/orange */
            color: #212529; /* Darker text for contrast */
        }

        .toast-notification.show {
            transform: translateX(0);
        }
        .toast-notification i {
            font-size: 1.25rem;
        }
        .toast-notification span {
            font-weight: 600;
        }


        /* -------------------------
         * Sidebar Navigation
         * ------------------------- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.3s ease, transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Align left */
            padding: 0 1.5rem;
            height: var(--header-height);
            border-bottom: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .sidebar-logo a {
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .sidebar-logo img {
            max-height: 36px;
            width: auto;
            transition: opacity 0.3s ease;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0.5rem; /* Padding for nav items */
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar-nav ul {
            list-style: none;
        }

        .sidebar-nav .nav-item {
            margin-bottom: 0.25rem;
        }

        .sidebar-nav .nav-link,
        .sidebar-nav .nav-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between; /* For chevron */
            padding: 0.8rem 1rem;
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            transition: background 0.2s, color 0.2s;
            white-space: nowrap;
            cursor: pointer;
        }

        .sidebar-nav .nav-link-inner,
        .sidebar-nav .nav-toggle-inner {
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .sidebar-nav .nav-link i,
        .sidebar-nav .nav-toggle i {
            font-size: 1.1rem;
            width: 30px;
            text-align: center;
            margin-right: 15px;
            flex-shrink: 0;
            transition: color 0.2s;
        }
        
        .sidebar-nav .nav-link span,
        .sidebar-nav .nav-toggle span {
            opacity: 1;
            transition: opacity 0.3s ease;
            font-size: 0.95rem;
        }

        .sidebar-nav .nav-link:hover,
        .sidebar-nav .nav-toggle:hover {
            background-color: var(--content-bg);
            color: var(--text-primary);
        }
        
        .sidebar-nav .nav-link.active,
        .sidebar-nav .nav-item.open > .nav-toggle {
            background-color: var(--primary-blue);
            color: var(--text-on-primary);
            box-shadow: var(--shadow-sm);
        }

        .sidebar-nav .nav-link.active i,
        .sidebar-nav .nav-item.open > .nav-toggle i {
            color: var(--text-on-primary);
        }
        
        .sidebar-nav .chevron-icon {
            font-size: 0.8rem;
            transition: transform 0.2s ease, opacity 0.3s ease;
            opacity: 1;
        }

        /* Submenu styles */
        .submenu {
            display: none;
            padding-left: 1.25rem; /* Indentation */
            margin-top: 0.25rem;
        }

        .submenu .nav-link {
            padding-top: 0.6rem;
            padding-bottom: 0.6rem;
            font-size: 0.9rem;
            padding-left: 2.5rem; /* Icon indentation + text */
        }
        
        .submenu .nav-link.active {
            color: var(--primary-blue);
            background-color: var(--content-bg);
        }

        .submenu .nav-link.active i {
             color: var(--primary-blue);
        }

        /* JS-toggled 'open' class */
        .nav-item.open > .submenu {
            display: block;
        }

        .nav-item.open > .nav-toggle .chevron-icon {
            transform: rotate(90deg);
        }


        /* -------------------------
         * Main Content Area
         * ------------------------- */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: margin-left 0.3s ease;
        }

        /* -------------------------
         * Top Bar (Header)
         * ------------------------- */
        .top-bar {
            height: var(--header-height);
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem 0 1.5rem;
            flex-shrink: 0;
            z-index: 900;
        }
        
        @media (min-width: 768px) {
            .top-bar {
                padding: 0 2rem;
            }
        }
        
        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .icon-btn {
            font-size: 1.25rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
            padding: 0.5rem;
            border-radius: var(--radius-md);
        }
        
        .icon-btn:hover {
            color: var(--text-primary);
            background-color: var(--content-bg);
        }
        
        #sidebar-toggle {
            font-size: 1.4rem;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-blue);
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* -------------------------
         * Main Content
         * ------------------------- */
        .content-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        @media (min-width: 768px) {
            .content-area {
                padding: 2.5rem;
            }
        }
        
        /* Dashboard Card Styles */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }

        .plant-card {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-hover) 100%);
            color: #ffffff;
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .plant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .plant-card span {
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            z-index: 2;
            position: relative;
        }

        .plant-card::after {
            content: "\f013"; /* Gear icon */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            right: 1rem;
            bottom: 0.5rem;
            font-size: 6rem;
            color: rgba(255, 255, 255, 0.1);
            z-index: 1;
            transform: rotate(-10deg);
        }
        
        /* -------------------------
         * Form & Page Content Styles
         * ------------------------- */
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .form-container {
            max-width: 600px;
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group select,
        .form-group input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: #ffffff;
            appearance: none;
        }
        
        .form-group select:disabled {
            background-color: var(--content-bg);
            cursor: not-allowed;
        }
        
        .form-group select:focus,
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(74, 105, 226, 0.2);
        }
        
        .form-group.select-group {
            position: relative;
        }
        
        .form-group.select-group::after {
            content: '\f078'; /* chevron-down */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            right: 1rem;
            top: calc(0.75rem + 1em); /* Aligns with select box padding */
            font-size: 0.9rem;
            color: var(--text-secondary);
            pointer-events: none;
        }

        /* Custom Multi-Select Dropdown */
        .custom-multiselect {
            position: relative;
        }
        
        .multiselect-display {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: #ffffff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-multiselect.disabled .multiselect-display {
            background-color: var(--content-bg);
            cursor: not-allowed;
        }
        
        .multiselect-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 1rem;
        }

        .multiselect-text.placeholder {
            color: var(--text-secondary);
        }

        .multiselect-display::after {
            content: '\f078'; /* chevron-down */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }
        
        .custom-multiselect.open .multiselect-display::after {
            transform: rotate(180deg);
        }
        
        .multiselect-options {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            width: 100%;
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .custom-multiselect.open .multiselect-options {
            display: block;
        }
        
        .multiselect-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .multiselect-option:hover {
            background-color: var(--content-bg);
        }
        
        .multiselect-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-blue);
        }
        
        /* Application Settings Page */
        .logo-uploader-container {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 1.5rem;
        }
        
        .logo-preview {
            width: 200px;
            height: 80px;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--content-bg);
            padding: 1rem;
        }
        
        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .logo-preview .placeholder {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
        }
        
        input[type="file"] {
            display: none;
        }

        .upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-blue);
            background-color: #f0f3ff;
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .upload-btn:hover {
            background-color: #e4e9ff;
        }
        
        /* -------------------------
         * GEMINI AI GENERATOR STYLES
         * ------------------------- */
        .page-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 1024px) {
            .page-grid {
                /* 60/40 split on desktop */
                grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
            }
        }

        .generator-container, .saved-items-container {
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }
        
        @media (min-width: 768px) {
             .generator-container, .saved-items-container {
                 padding: 2rem;
             }
        }

        .generator-container h3, .saved-items-container h3 {
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .generator-input, textarea.generator-input, textarea.generator-result {
            width: 100%;
            padding: 0.75rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
        }

        textarea.generator-input {
            min-height: 100px;
            resize: vertical;
        }

        textarea.generator-result {
            min-height: 250px;
            background-color: var(--content-bg);
            color: var(--text-primary);
            resize: vertical;
            line-height: 1.6;
        }

        .gemini-btn, .save-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
            background-color: var(--primary-blue);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .gemini-btn:hover, .save-btn:hover {
            background-color: var(--primary-hover);
        }

        .gemini-btn:disabled, .save-btn:disabled {
            background-color: #b0bce1;
            cursor: not-allowed;
        }
        
        .gemini-btn i.fa-spinner {
            display: none;
        }
        
        .gemini-btn.loading i.fa-wand-magic-sparkles {
            display: none;
        }
        .gemini-btn.loading i.fa-spinner {
            display: inline-block;
        }

        .save-btn {
            background-color: #1a7f37; /* Green save button */
            margin-top: 0.5rem;
        }
        
        .save-btn:hover {
            background-color: #15692e;
        }
        
        .save-btn i.fa-spinner {
            display: none;
        }
        .save-btn.loading i.fa-save {
            display: none;
        }
        .save-btn.loading i.fa-spinner {
            display: inline-block;
        }

        /* Saved Items List */
        .saved-items-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .saved-item-placeholder {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            padding: 2rem 0;
        }
        
        .saved-item {
            background: var(--content-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .saved-item.email .item-title {
            font-weight: 600;
            color: var(--text-primary);
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .saved-item.email .item-body {
            font-weight: 400;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* -------------------------
         * MOBILE: Collapsed Sidebar
         * ------------------------- */
        .page-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        @media (max-width: 767px) {
            .sidebar {
                position: fixed;
                height: 100%;
                transform: translateX(-100%);
            }
            
            body.sidebar-mobile-open .sidebar {
                transform: translateX(0);
            }
            
            body.sidebar-mobile-open .page-overlay {
                opacity: 1;
                pointer-events: auto;
            }
            
            /* Hide toggle on mobile, it's in the header */
            #sidebar-toggle-desktop {
                display: none;
            }
        }
        

        /* -------------------------
         * DESKTOP: Collapsed Sidebar
         * ------------------------- */
        @media (min-width: 768px) {
            /* Hide mobile-only toggle */
            #sidebar-toggle-mobile {
                display: none;
            }
            
            body.sidebar-collapsed .sidebar {
                width: var(--sidebar-width-collapsed);
            }

            body.sidebar-collapsed .sidebar-logo {
                justify-content: center;
                padding: 0 0.5rem;
            }
            
            body.sidebar-collapsed .sidebar-logo img {
                max-height: 32px;
            }

            body.sidebar-collapsed .sidebar-nav .nav-link,
            body.sidebar-collapsed .sidebar-nav .nav-toggle {
                justify-content: center;
            }

            body.sidebar-collapsed .sidebar-nav .nav-link-inner,
            body.sidebar-collapsed .sidebar-nav .nav-toggle-inner {
                justify-content: center;
                width: 100%;
            }

            body.sidebar-collapsed .sidebar-nav .nav-link i,
            body.sidebar-collapsed .sidebar-nav .nav-toggle i {
                margin-right: 0;
            }
            
            body.sidebar-collapsed .sidebar-nav .nav-link span,
            body.sidebar-collapsed .sidebar-nav .nav-toggle span,
            body.sidebar-collapsed .sidebar-nav .chevron-icon {
                opacity: 0;
                width: 0;
                pointer-events: none;
            }
            
            body.sidebar-collapsed .submenu {
                display: none !important; /* Force hide */
            }
            
            body.sidebar-collapsed .nav-item.open .chevron-icon {
                transform: rotate(0deg); /* Reset chevron */
            }
        }

    </style>
</head>
<body class="sidebar-collapsed"> <!-- Start collapsed on desktop -->

    <!-- Toast Notification Element -->
    <div id="toast-notification" class="toast-notification">
        <i class="fa-solid fa-check-circle"></i>
        <span id="toast-message">Saved!</span>
    </div>

    <!-- Mobile Page Overlay -->
    <div class="page-overlay" id="page-overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <a href="#" data-nav-id="dashboard">
                <img src="https://placehold.co/150x40/4A65E2/FFF?text=eQLM&font=inter" alt="eQLM Logo" id="sidebar-logo-img">
            </a>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item" data-nav-id="dashboard">
                    <a href="#" class="nav-link">
                        <div class="nav-link-inner">
                            <i class="fa-solid fa-table-columns"></i>
                            <span>Dashboard</span>
                        </div>
                    </a>
                </li>
                
                <li class="nav-item" data-nav-id="labworks">
                    <a class="nav-toggle">
                        <div class="nav-toggle-inner">
                            <i class="fa-solid fa-flask"></i>
                            <span>LabWorks</span>
                        </div>
                        <i class="fa-solid fa-chevron-right chevron-icon"></i>
                    </a>
                    <ul class="submenu">
                        <li class="nav-item"><a href="#" class="nav-link">Overview</a></li>
                        <li class="nav-item"><a href="#" class="nav-link">All Tests</a></li>
                        <li class="nav-item"><a href="#" class="nav-link">New Test</a></li>
                    </ul>
                </li>

                <li class="nav-item" data-nav-id="users">
                    <a class="nav-toggle">
                        <div class="nav-toggle-inner">
                            <i class="fa-solid fa-users"></i>
                            <span>User Management</span>
                        </div>
                        <i class="fa-solid fa-chevron-right chevron-icon"></i>
                    </a>
                    <ul class="submenu">
                        <li class="nav-item"><a href="#" class="nav-link">All Users</a></li>
                        <li class="nav-item"><a href="#" class="nav-link">Roles & Permissions</a></li>
                    </ul>
                </li>

                <li class="nav-item" data-nav-id="config">
                    <a class="nav-toggle">
                        <div class="nav-toggle-inner">
                            <i class="fa-solid fa-gear"></i>
                            <span>Configuration</span>
                        </div>
                        <i class="fa-solid fa-chevron-right chevron-icon"></i>
                    </a>
                    <ul class="submenu">
                        <li class="nav-item" data-nav-id="config-app"><a href="#" class="nav-link">Application Setting</a></li>
                        <li class="nav-item" data-nav-id="config-workflow"><a href="#" class="nav-link">Workflows</a></li>
                        <li class="nav-item" data-nav-id="config-email"><a href="#" class="nav-link">Email Templates</a></li>
                        <li class="nav-item" data-nav-id="config-assign-lab"><a href="#" class="nav-link">Assign Lab Properties</a></li>
                    </ul>
                </li>

                <li class="nav-item" data-nav-id="reports">
                    <a class="nav-toggle">
                        <div class="nav-toggle-inner">
                            <i class="fa-solid fa-chart-pie"></i>
                            <span>Reports</span>
                        </div>
                        <i class="fa-solid fa-chevron-right chevron-icon"></i>
                    </a>
                    <ul class="submenu">
                        <li class="nav-item"><a href="#" class="nav-link">Quality Reports</a></li>
                        <li class="nav-item"><a href="#" class="nav-link">Usage Reports</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">

        <!-- Top Header Bar -->
        <header class="top-bar">
            <div class="top-bar-left">
                <!-- This toggle is for both desktop and mobile -->
                <i class="fa-solid fa-bars icon-btn" id="sidebar-toggle"></i>
                <h1 class="page-title" id="page-title">Plant Dashboard</h1>
            </div>
            <div class="user-controls">
                <i class="fa-solid fa-search icon-btn"></i>
                <i class="fa-solid fa-bell icon-btn"></i>
                <div class="user-avatar">SM</div>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <main class="content-area" id="content-area">
            <!-- Content will be loaded here by JavaScript -->
        </main>
    </div>

    <script>
        // --- DATA HIERARCHY (New) ---
        // This object represents the entire data structure for the Assign Lab Properties page.
        const plantData = {
            "Fernley": {
                "Decking": {
                    "buildings": {}, // Fernley > Decking has no buildings
                    "labs": {
                        "Embossing": {"items": []},
                        "Shell Thickness": {"items": []},
                        "Moisture": {"items": []},
                        "Ski-tipping": {"items": []},
                        "Retest": {
                            "labs": { // This is a nested lab group, treated like a "building"
                                "Bulge": {"items": []},
                                "Flatness": {"items": []},
                                "Offset": {"items": []},
                                "Width": {"items": []},
                                "Thickness": {"items": []}
                            }
                        }
                    }
                }
            },
            "Winchester": {
                "Decking": {
                    "buildings": {
                        "Building 1": {
                            "labs": {
                                "Embossing": {"items": []},
                                "Shell Thickness": {"items": []},
                                "Moisture": {"items": []},
                                "Skitipping": {"items": []},
                                "Retest": {
                                    "labs": {
                                        "Bulge": {"items": []},
                                        "Flatness": {"items": []},
                                        "Offset": {"items": []},
                                        "Width": {"items": []},
                                        "Thickness": {"items": []}
                                    }
                                }
                            }
                        },
                        "Building 3": { // Assumed same structure as Building 1
                            "labs": {
                                "Embossing": {"items": []},
                                "Shell Thickness": {"items": []},
                                "Moisture": {"items": []},
                                "Skitipping": {"items": []},
                                "Retest": {
                                    "labs": {
                                        "Bulge": {"items": []},
                                        "Flatness": {"items": []},
                                        "Offset": {"items": []},
                                        "Width": {"items": []},
                                        "Thickness": {"items": []}
                                    }
                                }
                            }
                        },
                        "Building 4": { // Assumed same structure as Building 1
                            "labs": {
                                "Embossing": {"items": []},
                                "Shell Thickness": {"items": []},
                                "Moisture": {"items": []},
                                "Skitipping": {"items": []},
                                "Retest": {
                                    "labs": {
                                        "Bulge": {"items": []},
                                        "Flatness": {"items": []},
                                        "Offset": {"items": []},
                                        "Width": {"items": []},
                                        "Thickness": {"items": []}
                                    }
                                }
                            }
                        },
                        "Building 6": { // Assumed same structure as Building 1
                            "labs": {
                                "Embossing": {"items": []},
                                "Shell Thickness": {"items": []},
                                "Moisture": {"items": []},
                                "Skitipping": {"items": []},
                                "Retest": {
                                    "labs": {
                                        "Bulge": {"items": []},
                                        "Flatness": {"items": []},
                                        "Offset": {"items": []},
                                        "Width": {"items": []},
                                        "Thickness": {"items": []}
                                    }
                                }
                            }
                        }
                    }
                },
                "Railing": {
                    "buildings": {}, // No buildings mentioned
                    "labs": {
                        "Strength": {"items": []},
                        "Bow Results": {"items": []},
                        "VMM Dimension Documentation Dashboard": {"items": []},
                        "Railing Color Dashboard": {"items": []}
                    }
                },
                "Shell Stock Compounding": {
                    "buildings": {}, // No buildings mentioned
                    "labs": {
                        "Shell Stock": {"items": []},
                        "Streaker Testing": {"items": []},
                        "incoming Raw Material": {"items": []},
                        "TSC": {"items": []}
                    }
                },
                "Signature Decking": {
                    "buildings": {}, // No buildings mentioned
                    "labs": {
                        "Surface Energy": {"items": []},
                        "Adhesive Weight": {"items": []},
                        "Peel Strength": {"items": []}
                    }
                },
                "Signature Railing": {
                    "buildings": {}, // No buildings mentioned
                    "labs": {
                        "Load Testing": {"items": []},
                        "QC Checks": {"items": []}
                    }
                }
            }
        };


        // --- TEMPLATES for Dynamic Pages ---
        
        const dashboardContent = `
            <div class="card-container">
                <a href="#" class="plant-card">
                    <span>FERNLEY</span>
                </a>
                <a href="#" class="plant-card">
                    <span>WINCHESTER</span>
                </a>
            </div>
        `;

        // --- NEW Assign Lab Properties Content ---
        const assignLabPropertiesContent = `
            <div class="form-container">
                <!-- Dropdown 1: Select Lab (Multi-Select) -->
                <div class="form-group">
                    <label>Select Lab</label>
                    <div class="custom-multiselect" id="select-lab-wrapper">
                        <div class="multiselect-display">
                            <span class="multiselect-text placeholder">Select</span>
                        </div>
                        <div class="multiselect-options" id="select-lab-options">
                            <!-- Lab options will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Dropdown 2: Select Plant (Multi-Select) -->
                <div class="form-group">
                    <label>Select Plant</label>
                    <div class="custom-multiselect disabled" id="select-plant-wrapper">
                        <div class="multiselect-display">
                            <span class="multiselect-text placeholder">Select</span>
                        </div>
                        <div class="multiselect-options" id="select-plant-options">
                            <!-- Plant options will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Dropdown 3: Select Section (Multi-Select) -->
                <div class="form-group">
                    <label>Select Section</label>
                    <div class="custom-multiselect disabled" id="select-section-wrapper">
                        <div class="multiselect-display">
                            <span class="multiselect-text placeholder">Select</span>
                        </div>
                        <div class="multiselect-options" id="select-section-options">
                            <!-- Section options will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Dropdown 4: Select Building (Multi-Select) -->
                <div class="form-group">
                    <label>Select Building</label>
                    <div class="custom-multiselect disabled" id="select-building-wrapper">
                        <div class="multiselect-display">
                            <span class="multiselect-text placeholder">Select</span>
                        </div>
                        <div class="multiselect-options" id="select-building-options">
                            <!-- Building options will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Dropdown 5: Select Items to Add (Single-Select) -->
                <div class="form-group select-group">
                    <label for="select-items-to-add">Select Items to Add</label>
                    <select id="select-items-to-add" disabled>
                        <option value="" selected>Select</option>
                        <!-- To be populated later -->
                        <option value="item1">Item 1 (Placeholder)</option>
                        <option value="item2">Item 2 (Placeholder)</option>
                    </select>
                </div>
                
                <button class="save-btn" id="save-lab-settings" style="width: 100%;">
                    <i class="fa-solid fa-save"></i>
                    <i class="fa-solid fa-spinner fa-spin"></i>
                    <span>Save Settings</span>
                </button>
            </div>
        `;

        const applicationSettingsContent = `
            <div class="form-container">
                <div class="logo-uploader-container">
                    <h3>Application Logo</h3>
                    <div class="logo-preview" id="logo-preview">
                        <span class="placeholder">No logo uploaded</span>
                        <img src="" alt="Logo Preview" id="logo-preview-img" style="display:none;">
                    </div>
                    <label for="logo-uploader" class="upload-btn">
                        <i class="fa-solid fa-upload"></i>
                        <span>Upload New Logo</span>
                    </label>
                    <input type="file" id="logo-uploader" accept="image/png, image/jpeg, image/svg+xml">
                </div>
            </div>
        `;

        const workflowContent = `
            <div class="page-grid page-container">
                <div class="generator-container">
                    <h3>Create New Workflow</h3>
                    <div class="form-group">
                        <label for="workflow-prompt">Describe the workflow goal:</label>
                        <textarea id="workflow-prompt" class="generator-input" placeholder="e.g., 'Quality check process for Shell Thickness' or 'New user onboarding for lab technicians'"></textarea>
                    </div>
                    <button class="gemini-btn" id="generate-workflow-btn">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        <span>Generate Workflow</span>
                    </button>
                    
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label for="workflow-result">Generated Workflow Steps:</label>
                        <textarea id="workflow-result" class="generator-result" readonly></textarea>
                    </div>

                    <button class="save-btn" id="save-workflow-btn" style="display: none;">
                        <i class="fa-solid fa-save"></i>
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        <span>Save Workflow</span>
                    </button>
                </div>
                <div class="saved-items-container">
                    <h3>Saved Workflows</h3>
                    <div class="saved-items-list" id="saved-workflows-list">
                        <div class="saved-item-placeholder" id="workflow-placeholder">
                            No saved workflows yet
                        </div>
                    </div>
                </div>
            </div>
        `;

        const emailTemplatesContent = `
            <div class="page-grid page-container">
                <div class="generator-container">
                    <h3>Create New Email Template</h3>
                    <div class="form-group">
                        <label for="email-prompt">Describe the email's purpose:</label>
                        <input type="text" id="email-prompt" class="generator-input" placeholder="e.g., 'Alert for failed lab test' or 'Weekly quality summary report'">
                    </div>
                    <button class="gemini-btn" id="generate-email-btn">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        <span>Generate Email</span>
                    </button>
                    
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label for="email-result">Generated Email Template:</label>
                        <textarea id="email-result" class="generator-result" readonly></textarea>
                    </div>

                    <button class="save-btn" id="save-email-btn" style="display: none;">
                        <i class="fa-solid fa-save"></i>
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        <span>Save Email Template</span>
                    </button>
                </div>
                <div class="saved-items-container">
                    <h3>Saved Templates</h3>
                    <div class="saved-items-list" id="saved-emails-list">
                        <div class="saved-item-placeholder" id="email-placeholder">
                            No saved templates yet
                        </div>
                    </div>
                </div>
            </div>
        `;


        // --- MAIN SCRIPT ---

        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Global State ---
            let savedWorkflows = [];
            let savedEmailTemplates = [];
            let flatLabDatabase = []; // For easy lab lookup
            
            // --- DOM Elements ---
            const body = document.body;
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const pageOverlay = document.getElementById('page-overlay');
            const contentArea = document.getElementById('content-area');
            const pageTitle = document.getElementById('page-title');
            const allNavLinks = document.querySelectorAll('.nav-link');
            const allNavToggles = document.querySelectorAll('.nav-toggle');

            const mobileBreakpoint = 767;

            // --- Page Loading Functions ---
            
            function loadPage(title, content, navId) {
                pageTitle.textContent = title;
                contentArea.innerHTML = content;
                setActiveNav(navId);
                
                // Add page-specific initializers here
                if (navId === 'config-assign-lab') {
                    initializeAssignLabPage(); // NEW initializer for this specific page
                    document.getElementById('save-lab-settings').addEventListener('click', handleSaveAssignLab);
                }
                if (navId === 'config-app') {
                    document.getElementById('logo-uploader').addEventListener('change', handleLogoUpload);
                    loadLogoFromStorage(); // Load preview on page load
                }
                if (navId === 'config-workflow') {
                    document.getElementById('generate-workflow-btn').addEventListener('click', handleWorkflowGeneration);
                    document.getElementById('save-workflow-btn').addEventListener('click', handleSaveWorkflow);
                    renderSavedWorkflows();
                }
                if (navId === 'config-email') {
                    document.getElementById('generate-email-btn').addEventListener('click', handleEmailGeneration);
                    document.getElementById('save-email-btn').addEventListener('click', handleSaveEmail);
                    renderSavedEmails();
                }
                
                closeMobileSidebar();
            }

            // --- Navigation Handlers ---
            
            // Handle clicks on all nav links
            allNavLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const navItem = this.closest('.nav-item');
                    if (!navItem) return;
                    
                    const navId = navItem.dataset.navId;
                    
                    switch(navId) {
                        case 'dashboard':
                            loadPage('Plant Dashboard', dashboardContent, 'dashboard');
                            break;
                        case 'config-app':
                            loadPage('Application Setting', applicationSettingsContent, 'config-app');
                            break;
                        case 'config-assign-lab':
                            loadPage('Assign Lab Properties', assignLabPropertiesContent, 'config-assign-lab');
                            break;
                        case 'config-workflow':
                            loadPage('Workflows', workflowContent, 'config-workflow');
                            break;
                        case 'config-email':
                            loadPage('Email Templates', emailTemplatesContent, 'config-email');
                            break;
                        // Add other cases here for LabWorks, Users, etc.
                        default:
                            // Placeholder for non-implemented links
                            console.log(`Maps to ${navId}`);
                            setActiveNav(navId);
                            closeMobileSidebar();
                    }
                });
            });

            // Handle clicks on submenu toggles
            allNavToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    if (body.classList.contains('sidebar-collapsed') && window.innerWidth > mobileBreakpoint) {
                        return; // Do nothing if sidebar is collapsed on desktop
                    }
                    this.closest('.nav-item').classList.toggle('open');
                });
            });

            // Set the active navigation link
            function setActiveNav(navId) {
                // Remove active from all links and parent toggles
                allNavLinks.forEach(link => link.classList.remove('active'));
                allNavToggles.forEach(toggle => toggle.classList.remove('active'));
                document.querySelectorAll('.nav-item.open').forEach(item => item.classList.remove('open'));

                const activeLink = document.querySelector(`.nav-item[data-nav-id="${navId}"] > .nav-link`);
                
                if (activeLink) {
                    activeLink.classList.add('active');
                    const parentToggle = activeLink.closest('.submenu')?.closest('.nav-item');
                    if(parentToggle) {
                        parentToggle.classList.add('open');
                        parentToggle.querySelector('.nav-toggle')?.classList.add('active');
                    }
                } else {
                    // It's a submenu link
                    const activeSubLink = document.querySelector(`.nav-item[data-nav-id="${navId}"] .nav-link`);
                    if(activeSubLink) {
                        activeSubLink.classList.add('active');
                         const parentToggle = activeSubLink.closest('.submenu').closest('.nav-item');
                         if(parentToggle) {
                            parentToggle.classList.add('open');
                            parentToggle.querySelector('.nav-toggle').classList.add('active');
                        }
                    }
                }
            }


            // --- Sidebar Toggle Logic ---
            sidebarToggle.addEventListener('click', function() {
                if (window.innerWidth <= mobileBreakpoint) {
                    // Mobile: toggle flyout
                    body.classList.toggle('sidebar-mobile-open');
                } else {
                    // Desktop: toggle collapse
                    body.classList.toggle('sidebar-collapsed');
                    // Close any open submenus when collapsing
                    if (body.classList.contains('sidebar-collapsed')) {
                        document.querySelectorAll('.nav-item.open').forEach(item => {
                            item.classList.remove('open');
                        });
                    }
                }
            });
            
            // Close mobile sidebar when overlay is clicked
            pageOverlay.addEventListener('click', function() {
                body.classList.remove('sidebar-mobile-open');
            });

            function closeMobileSidebar() {
                if (window.innerWidth <= mobileBreakpoint) {
                    body.classList.remove('sidebar-mobile-open');
                }
            }
            
            // --- Toast Notification ---
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast-notification');
                const toastMessage = document.getElementById('toast-message');
                const toastIcon = toast.querySelector('i');

                toast.className = 'toast-notification'; // Reset classes
                if (type) {
                    toast.classList.add(type);
                }

                toastMessage.textContent = message;
                
                if (type === 'warning') {
                    toastIcon.className = 'fa-solid fa-triangle-exclamation';
                } else {
                    toastIcon.className = 'fa-solid fa-check-circle';
                }

                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000); // Hide after 3 seconds
            }

            // --- Logo Upload Logic ---
            function handleLogoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    // Update preview
                    document.getElementById('logo-preview-img').src = imageUrl;
                    document.getElementById('logo-preview-img').style.display = 'block';
                    document.querySelector('.logo-preview .placeholder').style.display = 'none';
                    
                    // Update sidebar logo
                    document.getElementById('sidebar-logo-img').src = imageUrl;
                    
                    // Save to localStorage
                    localStorage.setItem('eqlm-logo', imageUrl);
                    showToast('Logo updated!');
                };
                reader.readAsDataURL(file);
            }

            function loadLogoFromStorage() {
                const savedLogo = localStorage.getItem('eqlm-logo');
                if (savedLogo) {
                    // Update sidebar
                    document.getElementById('sidebar-logo-img').src = savedLogo;
                    
                    // Update preview page (if it exists)
                    const previewImg = document.getElementById('logo-preview-img');
                    if (previewImg) {
                        previewImg.src = savedLogo;
                        previewImg.style.display = 'block';
                        document.querySelector('.logo-preview .placeholder').style.display = 'none';
                    }
                }
            }

            // --- GEMINI API CALL LOGIC ---

            /**
             * Retries fetch with exponential backoff.
             */
            async function retryFetch(url, options, retries = 5, delay = 1000) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                         // Don't retry on client errors (4xx)
                        if (response.status >= 400 && response.status < 500) {
                            throw new Error(`API Client Error: ${response.status} ${response.statusText}`);
                        }
                        // Retry on server errors (5xx)
                        throw new Error(`API Server Error: ${response.status} ${response.statusText}`);
                    }
                    return response;
                } catch (err) {
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return retryFetch(url, options, retries - 1, delay * 2);
                    } else {
                        throw new Error("Max retries reached. " + err.message);
                    }
                }
            }

            /**
             * Generic function to call the Gemini API.
             */
            async function callGeminiAPI(userPrompt, systemPrompt, resultElement, loaderElement, buttonElement, saveButton) {
                buttonElement.classList.add('loading');
                buttonElement.disabled = true;
                resultElement.value = "";
                if(saveButton) saveButton.style.display = 'none';

                const apiKey = ""; // API key is handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                try {
                    const response = await retryFetch(apiUrl, fetchOptions);
                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0]?.text;
                        resultElement.value = text;
                        if(saveButton) saveButton.style.display = 'inline-block';
                    } else if (result.error) {
                         throw new Error(result.error.message);
                    } else {
                        throw new Error("Invalid response structure from API.");
                    }

                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    resultElement.value = `Error: ${error.message}\n\nPlease check your API key, network connection, and console for more details.`;
                } finally {
                    buttonElement.classList.remove('loading');
                    buttonElement.disabled = false;
                }
            }

            /**
             * Handles the "Generate Workflow" button click.
             */
            function handleWorkflowGeneration() {
                const promptElement = document.getElementById('workflow-prompt');
                const resultElement = document.getElementById('workflow-result');
                const buttonElement = document.getElementById('generate-workflow-btn');
                const saveButton = document.getElementById('save-workflow-btn');
                
                const userPrompt = promptElement.value;
                if (!userPrompt.trim()) {
                    showToast('Please describe the workflow goal.');
                    return;
                }

                const systemPrompt = "You are an expert in industrial plant management and quality assurance. Generate a clear, concise, step-by-step workflow based on the user's request. Format the output as a numbered list.";
                
                callGeminiAPI(userPrompt, systemPrompt, resultElement, null, buttonElement, saveButton);
            }

            /**
             * Handles the "Generate Email" button click.
             */
            function handleEmailGeneration() {
                const promptElement = document.getElementById('email-prompt');
                const resultElement = document.getElementById('email-result');
                const buttonElement = document.getElementById('generate-email-btn');
                const saveButton = document.getElementById('save-email-btn');

                const userPrompt = promptElement.value;
                if (!userPrompt.trim()) {
                    showToast("Please describe the email's purpose.");
                    return;
                }

                const systemPrompt = "You are a professional communications manager for an industrial plant. Write a clear and concise email template for the given purpose. The template must include a subject line (prefixed with 'Subject:') and a body. Use [BRACKETED_PLACEHOLDERS] for any dynamic content (e.g., [Plant_Name], [Test_Name], [Date]).";

                callGeminiAPI(userPrompt, systemPrompt, resultElement, null, buttonElement, saveButton);
            }
            
            // --- Save Generated Content Logic ---
            
            function handleSaveWorkflow() {
                const resultText = document.getElementById('workflow-result').value;
                if (!resultText) return;
                
                // Use the first line as the title, or a snippet
                const title = resultText.split('\n')[0].replace(/^\d+\.\s*/, '') || 'Workflow';
                savedWorkflows.push({ id: Date.now(), title: title, content: resultText });
                
                renderSavedWorkflows();
                showToast('Workflow saved!');
            }
            
            function renderSavedWorkflows() {
                const list = document.getElementById('saved-workflows-list');
                const placeholder = document.getElementById('workflow-placeholder');
                if (!list) return;
                
                list.innerHTML = ''; // Clear list
                
                if (savedWorkflows.length === 0) {
                    list.appendChild(placeholder);
                } else {
                    savedWorkflows.forEach(wf => {
                        const item = document.createElement('div');
                        item.className = 'saved-item workflow';
                        item.textContent = wf.title;
                        list.appendChild(item);
                    });
                }
            }

            function handleSaveEmail() {
                const resultText = document.getElementById('email-result').value;
                if (!resultText) return;

                let subject = 'Email Template';
                let body = resultText;

                const subjectMatch = resultText.match(/Subject:(.*)/i);
                if (subjectMatch && subjectMatch[1]) {
                    subject = subjectMatch[1].trim();
                    body = resultText.substring(resultText.indexOf('\n') + 1).trim();
                }

                savedEmailTemplates.push({ id: Date.now(), subject: subject, body: body });
                
                renderSavedEmails();
                showToast('Email template saved!');
            }
            
            function renderSavedEmails() {
                 const list = document.getElementById('saved-emails-list');
                 const placeholder = document.getElementById('email-placeholder');
                 if (!list) return;
                
                 list.innerHTML = ''; // Clear list
                
                 if (savedEmailTemplates.length === 0) {
                    list.appendChild(placeholder);
                 } else {
                    savedEmailTemplates.forEach(email => {
                        const item = document.createElement('div');
                        item.className = 'saved-item email';
                        item.innerHTML = `
                            <span class="item-title">${email.subject}</span>
                            <span class="item-body">${email.body.split('\n')[0]}</span>
                        `;
                        list.appendChild(item);
                    });
                }
            }
            
            // --- Save Assign Lab Properties ---
            function handleSaveAssignLab() {
                const button = document.getElementById('save-lab-settings');
                button.classList.add('loading');
                button.disabled = true;
                
                // Simulate network request
                setTimeout(() => {
                    button.classList.remove('loading');
                    button.disabled = false;
                    showToast('Settings saved successfully!');
                }, 1500);
            }


            // --- Custom Multi-Select Dropdown Logic ---
            // This is the generic initializer
            function initializeMultiSelects() {
                document.querySelectorAll('.custom-multiselect:not(.lab-property-form)').forEach(container => {
                    const display = container.querySelector('.multiselect-display');
                    const options = container.querySelectorAll('.multiselect-option input[type="checkbox"]');
                    
                    // Toggle dropdown
                    display.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Close other dropdowns
                        document.querySelectorAll('.custom-multiselect.open').forEach(openDropdown => {
                            if (openDropdown !== container) {
                                openDropdown.classList.remove('open');
                            }
                        });
                        container.classList.toggle('open');
                    });
                    
                    // Update text on checkbox change
                    options.forEach(option => {
                        option.addEventListener('change', () => {
                            updateMultiselectText(container);
                        });
                    });
                    
                    // Initial text update
                    updateMultiselectText(container);
                });
            }

            // MODIFIED: updateMultiselectText to show comma-separated list
            function updateMultiselectText(container) {
                const textElement = container.querySelector('.multiselect-text');
                const selectedOptions = Array.from(container.querySelectorAll('.multiselect-option input[type="checkbox"]:checked'));
                
                if (selectedOptions.length === 0) {
                    textElement.textContent = 'Select';
                    textElement.classList.add('placeholder');
                } else {
                    textElement.classList.remove('placeholder');
                    let text = selectedOptions.map(opt => opt.nextElementSibling.textContent).join(', ');
                    if (text.length > 35) { // Truncate if too long
                        textElement.textContent = `${selectedOptions.length} selected`;
                    } else {
                        textElement.textContent = text;
                    }
                }
            }
            
            // Global click listener to close dropdowns
            document.addEventListener('click', (e) => {
                 // If the click is not inside a multiselect that should be persistent, close it.
                const openDropdowns = document.querySelectorAll('.custom-multiselect.open');
                openDropdowns.forEach(dropdown => {
                    if (!dropdown.contains(e.target) && !dropdown.dataset.isPersistent) {
                        dropdown.classList.remove('open');
                    }
                });
            });

            // --- NEW: Assign Lab Properties Page Logic ---

            function initializeAssignLabPage() {
                // 1. Flatten the lab data for easy lookup
                flatLabDatabase = [];
                Object.keys(plantData).forEach(plantName => {
                    Object.keys(plantData[plantName]).forEach(sectionName => {
                        const section = plantData[plantName][sectionName];
                        
                        const processLabs = (labs, buildingName = null, subgroupName = null) => {
                            Object.keys(labs).forEach(labName => {
                                if (labName === "Retest" && labs.Retest.labs) {
                                    processLabs(labs.Retest.labs, buildingName, "Retest");
                                } else {
                                    // Construct a unique path for display
                                    let pathParts = [plantName, sectionName];
                                    if (buildingName) pathParts.push(buildingName);
                                    
                                    let displayLabName = labName;
                                    // The original request implies subgroup is part of the lab name in the UI
                                    // e.g., "Retest - Bulge" but the data has it nested. We adapt here.
                                    if (subgroupName) {
                                        displayLabName = `${subgroupName} - ${labName}`;
                                    }

                                    let path = `${displayLabName} (${pathParts.join(' > ')})`;

                                    flatLabDatabase.push({
                                        id: `${plantName}_${sectionName}_${buildingName || ''}_${subgroupName || ''}_${labName}`.replace(/\s+/g, '-') as string,
                                        name: displayLabName, // Use the combined name
                                        plant: plantName,
                                        section: sectionName,
                                        building: buildingName,
                                        // A consistent "type" for validation, e.g., "Embossing"
                                        type: (labName).split(' ')[0] 
                                    });
                                }
                            });
                        };

                        if (section.labs) {
                            processLabs(section.labs);
                        }
                        if (section.buildings) {
                             Object.keys(section.buildings).forEach(buildingName => {
                                const building = section.buildings[buildingName];
                                if (building.labs) {
                                    processLabs(building.labs, buildingName);
                                }
                             });
                        }
                    });
                });
                
                // 2. Populate the initial Lab dropdown
                const uniqueLabs = [...new Map(flatLabDatabase.map(lab => [lab.path, lab])).values()];
                uniqueLabs.sort((a,b) => a.path.localeCompare(b.path));
                populateMultiSelect('select-lab-options', uniqueLabs.map(l => ({ value: l.id, text: l.path, 'data-lab-type': l.type })), onLabSelectionChange);
                initializeMultiSelect('select-lab-wrapper', true);
            }

            /**
             * Main handler for when a lab selection changes.
             */
            function onLabSelectionChange(e) {
                const labWrapper = document.getElementById('select-lab-wrapper');
                const selectedCheckboxes = Array.from(labWrapper.querySelectorAll('input:checked'));
                const changedCheckbox = e.target;

                // --- Lab Type Validation ---
                if (selectedCheckboxes.length > 0) {
                    const firstType = selectedCheckboxes[0].dataset.labType;
                    if (changedCheckbox.dataset.labType !== firstType) {
                        showToast('Please select labs of the same type.', 'warning');
                        changedCheckbox.checked = false; // Revert the selection
                        updateMultiselectText(labWrapper);
                        return; // Stop processing
                    }
                }
                
                updateMultiselectText(labWrapper);
                updateDependentFields();
            }

            /**
             * A single function to orchestrate all dependent field updates.
             * This is called when labs, plants, or sections change.
             */
            function updateDependentFields() {
                const selectedLabIds = getMultiSelectValues('select-lab-options');
                
                // If no labs are selected, reset everything.
                if (selectedLabIds.length === 0) {
                    resetMultiSelect('select-plant-wrapper', 'Select');
                    resetMultiSelect('select-section-wrapper', 'Select');
                    resetMultiSelect('select-building-wrapper', 'Select');
                    return;
                }

                const allSelectedLabs = flatLabDatabase.filter(lab => selectedLabIds.includes(lab.id));

                // --- Update Plants ---
                const relevantPlants = [...new Set(allSelectedLabs.map(lab => lab.plant))];
                populateMultiSelect('select-plant-options', relevantPlants.map(p => ({ value: p, text: p })), updateDependentFields, true);
                initializeMultiSelect('select-plant-wrapper');
                
                const selectedPlants = getMultiSelectValues('select-plant-options');

                // --- Update Sections ---
                const labsInSelectedPlants = allSelectedLabs.filter(lab => selectedPlants.includes(lab.plant));
                const relevantSections = [...new Set(labsInSelectedPlants.map(lab => lab.section))];
                populateMultiSelect('select-section-options', relevantSections.map(s => ({ value: s, text: s })), updateDependentFields, true);
                initializeMultiSelect('select-section-wrapper');

                const selectedSections = getMultiSelectValues('select-section-options');

                // --- Update Buildings ---
                const labsInSelectedSections = labsInSelectedPlants.filter(lab => selectedSections.includes(lab.section) && lab.building);
                const relevantBuildings = [...new Set(labsInSelectedSections.map(lab => lab.building))];
                
                if (relevantBuildings.length > 0) {
                    populateMultiSelect('select-building-options', relevantBuildings.map(b => ({ value: b, text: b })), null, true); // No callback needed for the last level
                    initializeMultiSelect('select-building-wrapper');
                } else {
                    resetMultiSelect('select-building-wrapper', 'N/A');
                }
            }

            // --- Multi-Select Helper Functions (Refactored) ---

            /**
             * Populates a multi-select dropdown with options.
             */
            function populateMultiSelect(optionsContainerId, items, changeCallback, allChecked = false) {
                const optionsContainer = document.getElementById(optionsContainerId);
                const wrapper = optionsContainer.closest('.custom-multiselect');
                
                // Preserve existing checked values to avoid resetting user selections
                const previouslyChecked = getMultiSelectValues(optionsContainerId);

                optionsContainer.innerHTML = ''; 

                items.forEach(item => {
                    const dataAttrs = Object.keys(item)
                        .filter(key => key.startsWith('data-'))
                        .map(key => `${key}="${item[key]}"`)
                        .join(' ');
                    
                    // If allChecked is true, check it. Otherwise, check if it was previously checked.
                    const isChecked = allChecked || previouslyChecked.includes(item.value);

                    const optionHTML = `
                        <label class="multiselect-option">
                            <input type="checkbox" value="${item.value}" ${dataAttrs} ${isChecked ? 'checked' : ''}>
                            <span>${item.text}</span>
                        </label>
                    `;
                    optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
                });

                if (changeCallback) {
                    optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.addEventListener('change', changeCallback);
                    });
                }
                
                if (wrapper) {
                    updateMultiselectText(wrapper);
                    wrapper.classList.toggle('disabled', items.length === 0);
                }
            }

            /**
             * Initializes the open/close behavior for a custom multi-select dropdown.
             */
            function initializeMultiSelect(wrapperId, isPersistent = false) {
                const container = document.getElementById(wrapperId);
                if (!container || container.dataset.initialized === 'true') return;

                const display = container.querySelector('.multiselect-display');
                container.dataset.isPersistent = isPersistent;
                
                display.addEventListener('click', (e) => {
                    if (container.classList.contains('disabled')) return;
                    e.stopPropagation();
                    container.classList.toggle('open');
                });
                
                container.dataset.initialized = 'true';
            }
            
            /**
             * Gets the values of checked checkboxes in a multi-select container.
             */
            function getMultiSelectValues(optionsContainerId) {
                return Array.from(document.querySelectorAll(`#${optionsContainerId} input[type="checkbox"]:checked`))
                    .map(cb => cb.value);
            }

            /**
             * Resets a multi-select dropdown to its initial state.
             */
            function resetMultiSelect(wrapperId, placeholder) {
                const wrapper = document.getElementById(wrapperId);
                const optionsContainer = wrapper.querySelector('.multiselect-options');
                
                wrapper.classList.add('disabled');
                optionsContainer.innerHTML = '';
                updateMultiselectText(wrapper, placeholder);
            }
            


            // --- INITIALIZATION ---
            
            // Load logo from storage on initial load
            loadLogoFromStorage();
            
            // Load initial page
            loadPage('Plant Dashboard', dashboardContent, 'dashboard');
            
            // Set initial active nav based on the loaded page
            setActiveNav('dashboard');

        });
    </script>
</body>
</html>
