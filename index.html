<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eQLM Plant Dashboard Prototype</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Configure Tailwind to use Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <!-- 
      This <style> block is for components that are dynamically 
      generated or need states that Tailwind's JIT can't see.
      It's minimal by design.
    -->
    <style>
        /* Base styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Scrollbar styling */
        .sidebar-nav::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-nav::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        .sidebar-nav::-webkit-scrollbar-track {
            background-color: transparent;
        }

        /* Custom styles for the multi-select dropdown.
         We use JS to toggle the 'open' class, and these styles react to it.
        */
        .custom-multiselect.open .multiselect-options {
            display: block;
        }
        .custom-multiselect.open .multiselect-chevron {
            transform: rotate(180deg);
        }

        /* Custom styles for saving/loading buttons */
        .gemini-btn i.fa-spinner,
        .save-btn i.fa-spinner {
            display: none;
        }
        .gemini-btn.loading i.fa-wand-magic-sparkles,
        .save-btn.loading i.fa-save {
            display: none;
        }
        .gemini-btn.loading i.fa-spinner,
        .save-btn.loading i.fa-spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Style for disabled lab options */
        .multiselect-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f9fafb; /* bg-gray-50 */
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-900 font-inter h-screen overflow-hidden">

    <!-- Toast Notification Element -->
    <div id="toast-notification" class="fixed top-5 right-5 z-[100] flex items-center gap-3 px-6 py-4 rounded-lg text-white shadow-lg transform translate-x-[120%] transition-transform duration-300 ease-in-out">
        <i id="toast-icon" class="fa-solid fa-check-circle text-xl"></i>
        <span id="toast-message" class="font-semibold">Saved!</span>
    </div>

    <!-- Mobile Page Overlay -->
    <div id="page-overlay" class="fixed inset-0 bg-black/50 z-20 lg:hidden opacity-0 transition-opacity duration-300 pointer-events-none"></div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:relative z-30 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col h-full 
                                   transition-all duration-300 ease-in-out 
                                   -translate-x-full lg:translate-x-0 
                                   lg:w-64"
                                   style="visibility: hidden;"> <!-- Hide until JS runs -->
            
            <!-- Sidebar Logo -->
            <div id="sidebar-logo-container" class="flex items-center h-16 px-4 border-b border-gray-200 flex-shrink-0 justify-between lg:justify-start">
                <a href="#" class="flex items-center gap-2" data-nav-id="dashboard">
                    <img src="https://placehold.co/150x40/4A65E2/FFF?text=eQLM&font=inter" alt="eQLM Logo" id="sidebar-logo-img" class="h-8 w-auto">
                </a>
                <!-- Mobile close button -->
                <button id="sidebar-close-btn" class="lg:hidden text-gray-500 hover:text-gray-800">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Sidebar Navigation -->
            <nav class="sidebar-nav flex-1 overflow-y-auto p-2 space-y-1">
                <ul>
                    <li class="nav-item" data-nav-id="dashboard">
                        <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 hover:text-blue-600">
                            <i class="fa-solid fa-table-columns w-6 text-center text-base"></i>
                            <span class="nav-text ml-3 font-medium text-sm transition-opacity duration-300">Dashboard</span>
                        </a>
                    </li>
                    
                    <li class="nav-item" data-nav-id="labworks">
                        <a class="nav-toggle flex items-center justify-between p-3 rounded-lg text-gray-600 hover:bg-gray-100 hover:text-blue-600 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fa-solid fa-flask w-6 text-center text-base"></i>
                                <span class="nav-text ml-3 font-medium text-sm transition-opacity duration-300">LabWorks</span>
                            </div>
                            <i class="fa-solid fa-chevron-right chevron-icon text-xs transition-transform duration-200"></i>
                        </a>
                        <ul class="submenu hidden pt-1 pl-8 space-y-1">
                            <li class="nav-item"><a href="#" class="nav-link block p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-blue-600 text-sm">Overview</a></li>
                            <li class="nav-item"><a href="#" class="nav-link block p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-blue-600 text-sm">All Tests</a></li>
                            <li class="nav-item"><a href="#" class="nav-link block p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-blue-600 text-sm">New Test</a></li>
                        </ul>
                    </li>

                    <li class="nav-item" data-nav-id="users">
                        <a class="nav-toggle flex items-center justify-between p-3 rounded-lg text-gray-600 hover:bg-gray-100 hover:text-blue-600 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fa-solid fa-users w-6 text-center text-base"></i>
                                <span class="nav-text ml-3 font-medium text-sm transition-opacity duration-300">User Management</span>
                            </div>
                            <i class="fa-solid fa-chevron-right chevron-icon text-xs transition-transform duration-200"></i>
                        </a>
                        <ul class="submenu hidden pt-1 pl-8 space-y-1">
                            <li class="nav-item"><a href="#" class="nav-link block p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-blue-600 text-sm">All Users</a></li>
                            <li class="nav-item"><a href="#" class="nav-link block p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-blue-600 text-sm">Roles & Permissions</a></li>
                        </ul>
                    </li>

                    <li class="nav-item" data-nav-id="config">
                        <a class="nav-toggle flex items-center justify-between p-3 rounded-lg text-gray-600 hover:bg-gray-100 hover:text-blue-600 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fa-solid fa-gear w-6 text-center text-base"></i>
                                <span class="nav-text ml-3 font-medium text-sm transition-opacity duration-300">Configuration</span>
                            </div>
                            <i class="fa-solid fa-chevron-right chevron-icon text-xs transition-transform duration-200"></i>
                        </a>
                        <ul class="submenu hidden pt-1 pl-8 space-y-1">
                            <li class="nav-item" data-nav-id="config-app"><a href="#" class="nav-link block p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-blue-600 text-sm">Application Setting</a></li>
                            <li class="nav-item" data-nav-id="config-workflow"><a href="#" class="nav-link block p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-blue-600 text-sm">Workflows</a></li>
                            <li class="nav-item" data-nav-id="config-email"><a href="#" class="nav-link block p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-blue-600 text-sm">Email Templates</a></li>
                            <li class="nav-item" data-nav-id="config-assign-lab"><a href="#" class="nav-link block p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-blue-600 text-sm">Assign Lab Properties</a></li>
                        </ul>
                    </li>

                    <li class="nav-item" data-nav-id="reports">
                        <a class="nav-toggle flex items-center justify-between p-3 rounded-lg text-gray-600 hover:bg-gray-100 hover:text-blue-600 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fa-solid fa-chart-pie w-6 text-center text-base"></i>
                                <span class="nav-text ml-3 font-medium text-sm transition-opacity duration-300">Reports</span>
                            </div>
                            <i class="fa-solid fa-chevron-right chevron-icon text-xs transition-transform duration-200"></i>
                        </a>
                        <ul class="submenu hidden pt-1 pl-8 space-y-1">
                            <li class="nav-item"><a href="#" class="nav-link block p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-blue-600 text-sm">Quality Reports</a></li>
                            <li class="nav-item"><a href="#" class="nav-link block p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-blue-600 text-sm">Usage Reports</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper flex-1 flex flex-col overflow-hidden">
            <!-- Top Header Bar -->
            <header class="top-bar h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 lg:px-6 flex-shrink-0">
                <div class="top-bar-left flex items-center gap-3">
                    <!-- Unified Sidebar Toggle -->
                    <button id="sidebar-toggle" class="icon-btn text-gray-600 hover:text-blue-600 text-xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <h1 class="page-title text-xl lg:text-2xl font-semibold text-gray-800" id="page-title">Plant Dashboard</h1>
                </div>
                <div class="user-controls flex items-center gap-4">
                    <button class="icon-btn text-gray-500 hover:text-blue-600 text-lg w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                        <i class="fa-solid fa-search"></i>
                    </button>
                    <button class="icon-btn text-gray-500 hover:text-blue-600 text-lg w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                        <i class="fa-solid fa-bell"></i>
                    </button>
                    <div class="user-avatar w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold text-sm cursor-pointer">
                        SM
                    </div>
                </div>
            </header>

            <!-- Dynamic Content Area -->
            <main class="content-area flex-1 p-4 lg:p-8 overflow-y-auto" id="content-area">
                <!-- Content will be loaded here by JavaScript -->
            </main>
        </div>
    </div>

    <script>
        // --- DATA HIERARCHY ---
        // This object represents the entire data structure for the Assign Lab Properties page.
        const plantData = {
            "Fernley": {
                "Decking": {
                    "buildings": {}, // Fernley > Decking has no buildings
                    "labs": {
                        "Embossing": {"items": []},
                        "Shell Thickness": {"items": []},
                        "Moisture": {"items": []},
                        "Ski-tipping": {"items": []},
                        "Retest": {
                            "labs": { // This is a nested lab group
                                "Bulge": {"items": []},
                                "Flatness": {"items": []},
                                "Offset": {"items": []},
                                "Width": {"items": []},
                                "Thickness": {"items": []}
                            }
                        }
                    }
                }
            },
            "Winchester": {
                "Decking": {
                    "buildings": {
                        "Building 1": {
                            "labs": {
                                "Embossing": {"items": []},
                                "Shell Thickness": {"items": []},
                                "Moisture": {"items": []},
                                "Skitipping": {"items": []},
                                "Retest": {
                                    "labs": {
                                        "Bulge": {"items": []},
                                        "Flatness": {"items": []},
                                        "Offset": {"items": []},
                                        "Width": {"items": []},
                                        "Thickness": {"items": []}
                                    }
                                }
                            }
                        },
                        "Building 3": { // Assumed same structure as Building 1
                            "labs": {
                                "Embossing": {"items": []},
                                "Shell Thickness": {"items": []},
                                "Moisture": {"items": []},
                                "Skitipping": {"items": []},
                                "Retest": {
                                    "labs": {
                                        "Bulge": {"items": []},
                                        "Flatness": {"items": []},
                                        "Offset": {"items": []},
                                        "Width": {"items": []},
                                        "Thickness": {"items": []}
                                    }
                                }
                            }
                        },
                        "Building 4": { // Assumed same structure as Building 1
                            "labs": {
                                "Embossing": {"items": []},
                                "Shell Thickness": {"items": []},
                                "Moisture": {"items": []},
                                "Skitipping": {"items": []},
                                "Retest": {
                                    "labs": {
                                        "Bulge": {"items": []},
                                        "Flatness": {"items": []},
                                        "Offset": {"items": []},
                                        "Width": {"items": []},
                                        "Thickness": {"items": []}
                                    }
                                }
                            }
                        },
                        "Building 6": { // Assumed same structure as Building 1
                            "labs": {
                                "Embossing": {"items": []},
                                "Shell Thickness": {"items": []},
                                "Moisture": {"items": []},
                                "Skitipping": {"items": []},
                                "Retest": {
                                    "labs": {
                                        "Bulge": {"items": []},
                                        "Flatness": {"items": []},
                                        "Offset": {"items": []},
                                        "Width": {"items": []},
                                        "Thickness": {"items": []}
                                    }
                                }
                            }
                        }
                    }
                },
                "Railing": {
                    "buildings": {}, // No buildings mentioned
                    "labs": {
                        "Strength": {"items": []},
                        "Bow Results": {"items": []},
                        "VMM Dimension Documentation Dashboard": {"items": []},
                        "Railing Color Dashboard": {"items": []}
                    }
                },
                "Shell Stock Compounding": {
                    "buildings": {}, // No buildings mentioned
                    "labs": {
                        "Shell Stock": {"items": []},
                        "Streaker Testing": {"items": []},
                        "incoming Raw Material": {"items": []},
                        "TSC": {"items": []}
                    }
                },
                "Signature Decking": {
                    "buildings": {}, // No buildings mentioned
                    "labs": {
                        "Surface Energy": {"items": []},
                        "Adhesive Weight": {"items": []},
                        "Peel Strength": {"items": []}
                    }
                },
                "Signature Railing": {
                    "buildings": {}, // No buildings mentioned
                    "labs": {
                        "Load Testing": {"items": []},
                        "QC Checks": {"items": []}
                    }
                }
            }
        };


        // --- TEMPLATES for Dynamic Pages (with Tailwind) ---
        
        const dashboardContent = `
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <a href="#" class="plant-card relative block p-8 rounded-xl shadow-lg bg-gradient-to-br from-blue-600 to-blue-700 text-white overflow-hidden transition-transform duration-200 hover:-translate-y-1">
                    <span class="relative z-10 text-2xl font-bold tracking-wide">FERNLEY</span>
                    <i class="fa-solid fa-gear absolute z-0 text-white/10 text-8xl bottom-0 right-0 transform -rotate-12 translate-x-4 translate-y-4"></i>
                </a>
                <a href="#" class="plant-card relative block p-8 rounded-xl shadow-lg bg-gradient-to-br from-blue-600 to-blue-700 text-white overflow-hidden transition-transform duration-200 hover:-translate-y-1">
                    <span class="relative z-10 text-2xl font-bold tracking-wide">WINCHESTER</span>
                    <i class="fa-solid fa-gear absolute z-0 text-white/10 text-8xl bottom-0 right-0 transform -rotate-12 translate-x-4 translate-y-4"></i>
                </a>
            </div>
        `;

        // --- Assign Lab Properties Content (NEW) ---
        const assignLabPropertiesContent = `
            <div class="form-container max-w-2xl mx-auto bg-white p-6 lg:p-8 rounded-xl shadow-md">
                
                <!-- Dropdown 1: Select Lab (NEW: Multi-Select) -->
                <div class="form-group mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Lab</label>
                    <div class="custom-multiselect" id="select-lab-wrapper">
                        <div class="multiselect-display flex justify-between items-center w-full rounded-md border border-gray-300 shadow-sm bg-white text-sm py-3 px-4 cursor-pointer">
                            <span class="multiselect-text placeholder text-gray-500 overflow-hidden text-ellipsis whitespace-nowrap pr-2">Select Lab(s)</span>
                            <i class="fa-solid fa-chevron-down multiselect-chevron text-gray-500 text-xs transition-transform duration-200"></i>
                        </div>
                        <div class="multiselect-options hidden absolute z-20 mt-1 w-full bg-white shadow-lg border border-gray-300 rounded-md max-h-60 overflow-auto" id="select-lab-options">
                            <!-- Lab options will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Field 2: Plant(s) (NEW: Read-only) -->
                <div class="form-group mb-5">
                    <label for="auto-plant" class="block text-sm font-medium text-gray-700 mb-1">Plant(s)</label>
                    <input type="text" id="auto-plant" readonly 
                           class="block w-full rounded-md border-gray-300 shadow-sm text-sm py-3 px-4 bg-gray-100 text-gray-600 cursor-not-allowed focus:ring-0 focus:border-gray-300">
                </div>

                <!-- Field 3: Section(s) (NEW: Read-only) -->
                <div class="form-group mb-5">
                    <label for="auto-section" class="block text-sm font-medium text-gray-700 mb-1">Section(s)</label>
                    <input type="text" id="auto-section" readonly 
                           class="block w-full rounded-md border-gray-300 shadow-sm text-sm py-3 px-4 bg-gray-100 text-gray-600 cursor-not-allowed focus:ring-0 focus:border-gray-300">
                </div>
                
                <!-- Field 4: Building/Group(s) (NEW: Read-only) -->
                <div class="form-group mb-5">
                    <label for="auto-building" class="block text-sm font-medium text-gray-700 mb-1">Building / Group(s)</label>
                    <input type="text" id="auto-building" readonly 
                           class="block w-full rounded-md border-gray-300 shadow-sm text-sm py-3 px-4 bg-gray-100 text-gray-600 cursor-not-allowed focus:ring-0 focus:border-gray-300">
                </div>

                <!-- Dropdown 5: Select Items to Add (Unchanged) -->
                <div class="form-group mb-6">
                    <label for="select-items-to-add" class="block text-sm font-medium text-gray-700 mb-1">Select Items to Add</label>
                    <div class="relative">
                        <select id="select-items-to-add" disabled class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-3 px-4 appearance-none disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="" selected>Select</option>
                            <option value="item1">Item 1 (Placeholder)</option>
                            <option value="item2">Item 2 (Placeholder)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>
                
                <button class="save-btn w-full flex items-center justify-center gap-2 px-4 py-3 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-300" id="save-lab-settings">
                    <i class="fa-solid fa-save"></i>
                    <i class="fa-solid fa-spinner"></i>
                    <span>Save Settings</span>
                </button>
            </div>
        `;

        const applicationSettingsContent = `
            <div class="form-container max-w-2xl mx-auto bg-white p-6 lg:p-8 rounded-xl shadow-md">
                <div class="logo-uploader-container flex flex-col items-center gap-6">
                    <h3 class="text-xl font-semibold text-gray-800">Application Logo</h3>
                    <div class="logo-preview w-52 h-24 border-2 border-dashed border-gray-300 rounded-md flex items-center justify-center bg-gray-50 p-2" id="logo-preview">
                        <span class="placeholder text-sm text-gray-500">No logo uploaded</span>
                        <img src="" alt="Logo Preview" id="logo-preview-img" class="max-w-full max-h-full object-contain" style="display:none;">
                    </div>
                    <label for="logo-uploader" class="upload-btn inline-flex items-center gap-2 px-4 py-2 bg-blue-100 text-blue-700 text-sm font-medium rounded-md cursor-pointer hover:bg-blue-200 transition-colors">
                        <i class="fa-solid fa-upload"></i>
                        <span>Upload New Logo</span>
                    </label>
                    <input type="file" id="logo-uploader" accept="image/png, image/jpeg, image/svg+xml" class="hidden">
                </div>
            </div>
        `;

        const workflowContent = `
            <div class="page-grid page-container max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="generator-container lg:col-span-3 bg-white p-6 lg:p-8 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Create New Workflow</h3>
                    <div class="form-group mb-4">
                        <label for="workflow-prompt" class="block text-sm font-medium text-gray-700 mb-1">Describe the workflow goal:</label>
                        <textarea id="workflow-prompt" class="generator-input block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm min-h-[100px]" placeholder="e.g., 'Quality check process for Shell Thickness' or 'New user onboarding for lab technicians'"></textarea>
                    </div>
                    <button class="gemini-btn inline-flex items-center justify-center gap-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300" id="generate-workflow-btn">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <i class="fa-solid fa-spinner"></i>
                        <span>Generate Workflow</span>
                    </button>
                    
                    <div class="form-group mt-6 mb-4">
                        <label for="workflow-result" class="block text-sm font-medium text-gray-700 mb-1">Generated Workflow Steps:</label>
                        <textarea id="workflow-result" class="generator-result block w-full rounded-md border-gray-300 shadow-sm bg-gray-50 sm:text-sm min-h-[250px] resize-vertical" readonly></textarea>
                    </div>

                    <button class="save-btn inline-flex items-center justify-center gap-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-300" id="save-workflow-btn" style="display: none;">
                        <i class="fa-solid fa-save"></i>
                        <i class="fa-solid fa-spinner"></i>
                        <span>Save Workflow</span>
                    </button>
                </div>
                <div class="saved-items-container lg:col-span-2 bg-white p-6 lg:p-8 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Saved Workflows</h3>
                    <div class="saved-items-list space-y-3" id="saved-workflows-list">
                        <div class="saved-item-placeholder text-center py-8 text-sm text-gray-500 italic" id="workflow-placeholder">
                            No saved workflows yet
                        </div>
                    </div>
                </div>
            </div>
        `;

        const emailTemplatesContent = `
            <div class="page-grid page-container max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="generator-container lg:col-span-3 bg-white p-6 lg:p-8 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Create New Email Template</h3>
                    <div class="form-group mb-4">
                        <label for="email-prompt" class="block text-sm font-medium text-gray-700 mb-1">Describe the email's purpose:</label>
                        <input type="text" id="email-prompt" class="generator-input block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., 'Alert for failed lab test' or 'Weekly quality summary report'">
                    </div>
                    <button class="gemini-btn inline-flex items-center justify-center gap-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300" id="generate-email-btn">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <i class="fa-solid fa-spinner"></i>
                        <span>Generate Email</span>
                    </button>
                    
                    <div class="form-group mt-6 mb-4">
                        <label for="email-result" class="block text-sm font-medium text-gray-700 mb-1">Generated Email Template:</label>
                        <textarea id="email-result" class="generator-result block w-full rounded-md border-gray-300 shadow-sm bg-gray-50 sm:text-sm min-h-[250px] resize-vertical" readonly></textarea>
                    </div>

                    <button class="save-btn inline-flex items-center justify-center gap-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-300" id="save-email-btn" style="display: none;">
                        <i class="fa-solid fa-save"></i>
                        <i class="fa-solid fa-spinner"></i>
                        <span>Save Email Template</span>
                    </button>
                </div>
                <div class="saved-items-container lg:col-span-2 bg-white p-6 lg:p-8 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Saved Templates</h3>
                    <div class="saved-items-list space-y-3" id="saved-emails-list">
                        <div class="saved-item-placeholder text-center py-8 text-sm text-gray-500 italic" id="email-placeholder">
                            No saved templates yet
                        </div>
                    </div>
                </div>
            </div>
        `;


        // --- MAIN SCRIPT ---

        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Global State ---
            let savedWorkflows = [];
            let savedEmailTemplates = [];
            let flatLabDatabase = []; // For easy lab lookup
            let selectedLabCategory = null; // For Req 2.2
            
            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
            const pageOverlay = document.getElementById('page-overlay');
            const contentArea = document.getElementById('content-area');
            const pageTitle = document.getElementById('page-title');
            const allNavLinks = document.querySelectorAll('.nav-link');
            const allNavToggles = document.querySelectorAll('.nav-toggle');

            const mobileBreakpoint = 1024; // Tailwind's `lg` breakpoint

            // --- Page Loading Functions ---
            
            function loadPage(title, content, navId) {
                pageTitle.textContent = title;
                contentArea.innerHTML = content;
                setActiveNav(navId);
                
                // Add page-specific initializers here
                if (navId === 'config-assign-lab') {
                    initializeAssignLabPage(); // NEW initializer for this specific page
                    document.getElementById('save-lab-settings').addEventListener('click', handleSaveAssignLab);
                }
                if (navId === 'config-app') {
                    document.getElementById('logo-uploader').addEventListener('change', handleLogoUpload);
                    loadLogoFromStorage(); // Load preview on page load
                }
                if (navId === 'config-workflow') {
                    document.getElementById('generate-workflow-btn').addEventListener('click', handleWorkflowGeneration);
                    document.getElementById('save-workflow-btn').addEventListener('click', handleSaveWorkflow);
                    renderSavedWorkflows();
                }
                if (navId === 'config-email') {
                    document.getElementById('generate-email-btn').addEventListener('click', handleEmailGeneration);
                    document.getElementById('save-email-btn').addEventListener('click', handleSaveEmail);
                    renderSavedEmails();
                }
                
                closeMobileSidebar();
            }

            // --- Navigation Handlers ---
            
            allNavLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const navItem = this.closest('.nav-item');
                    if (!navItem) return;
                    
                    const navId = navItem.dataset.navId;
                    
                    switch(navId) {
                        case 'dashboard':
                            loadPage('Plant Dashboard', dashboardContent, 'dashboard');
                            break;
                        case 'config-app':
                            loadPage('Application Setting', applicationSettingsContent, 'config-app');
                            break;
                        case 'config-assign-lab':
                            loadPage('Assign Lab Properties', assignLabPropertiesContent, 'config-assign-lab');
                            break;
                        case 'config-workflow':
                            loadPage('Workflows', workflowContent, 'config-workflow');
                            break;
                        case 'config-email':
                            loadPage('Email Templates', emailTemplatesContent, 'config-email');
                            break;
                        default:
                            console.log(`Maps to ${navId}`);
                            setActiveNav(navId);
                            closeMobileSidebar();
                    }
                });
            });

            allNavToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    // Don't allow opening submenus when sidebar is collapsed
                    if (sidebar.classList.contains('lg:w-20')) {
                        return;
                    }
                    
                    const navItem = this.closest('.nav-item');
                    const submenu = navItem.querySelector('.submenu');
                    const chevron = this.querySelector('.chevron-icon');

                    navItem.classList.toggle('open');
                    submenu.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-90');
                });
            });

            function setActiveNav(navId) {
                // Remove active classes
                document.querySelectorAll('.nav-link, .nav-toggle').forEach(el => el.classList.remove('active', 'bg-blue-600', 'text-white'));
                
                // Close all open submenus
                document.querySelectorAll('.nav-item.open').forEach(item => {
                    item.classList.remove('open');
                    item.querySelector('.submenu')?.classList.add('hidden');
                    item.querySelector('.chevron-icon')?.classList.remove('rotate-90');
                });

                const activeEl = document.querySelector(`.nav-item[data-nav-id="${navId}"]`);
                if (!activeEl) return;

                const link = activeEl.querySelector('.nav-link');
                
                if (link) {
                    // It's a top-level link
                    link.classList.add('active', 'bg-blue-600', 'text-white');
                    const parentToggleItem = link.closest('.submenu')?.closest('.nav-item');
                    if(parentToggleItem) {
                        // This is a submenu link
                        parentToggleItem.classList.add('open');
                        parentToggleItem.querySelector('.nav-toggle').classList.add('active', 'bg-blue-600', 'text-white');
                        parentToggleItem.querySelector('.submenu').classList.remove('hidden');
                        parentToggleItem.querySelector('.chevron-icon').classList.add('rotate-90');
                    }
                } else {
                    // It's a submenu link (clicked from the submenu itself)
                    const activeSubLink = activeEl.querySelector('.nav-link');
                    if(activeSubLink) {
                        activeSubLink.classList.add('active', 'text-blue-600');
                        activeSubLink.classList.remove('text-gray-500'); // ensure it's highlighted
                        
                        const parentToggleItem = activeEl.closest('.submenu').closest('.nav-item');
                        if(parentToggleItem) {
                            parentToggleItem.classList.add('open');
                            parentToggleItem.querySelector('.nav-toggle').classList.add('active', 'bg-blue-600', 'text-white');
                            parentToggleItem.querySelector('.submenu').classList.remove('hidden');
                            parentToggleItem.querySelector('.chevron-icon').classList.add('rotate-90');
                        }
                    }
                }
            }


            // --- Sidebar Toggle Logic (REQ 1) ---
            function toggleDesktopSidebar() {
                sidebar.classList.toggle('lg:w-64');
                sidebar.classList.toggle('lg:w-20');

                // Toggle logo container padding and justification
                const logoContainer = document.getElementById('sidebar-logo-container');
                logoContainer.classList.toggle('lg:justify-start');
                logoContainer.classList.toggle('lg:justify-center');
                logoContainer.classList.toggle('px-4');

                // Toggle nav text and chevrons
                document.querySelectorAll('.nav-text, .chevron-icon').forEach(el => {
                    el.classList.toggle('lg:hidden');
                });
                
                // Toggle justification for nav links
                document.querySelectorAll('.nav-link, .nav-toggle').forEach(el => {
                    el.classList.toggle('lg:justify-center');
                });

                // Close any open submenus
                document.querySelectorAll('.nav-item.open').forEach(item => {
                    item.classList.remove('open');
                    item.querySelector('.submenu')?.classList.add('hidden');
                    item.querySelector('.chevron-icon')?.classList.remove('rotate-90');
                });
            }

            function toggleMobileSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                pageOverlay.classList.toggle('opacity-0');
                pageOverlay.classList.toggle('pointer-events-none');
            }

            sidebarToggle.addEventListener('click', function() {
                if (window.innerWidth < mobileBreakpoint) {
                    toggleMobileSidebar();
                } else {
                    toggleDesktopSidebar();
                }
            });

            sidebarCloseBtn.addEventListener('click', toggleMobileSidebar);
            pageOverlay.addEventListener('click', toggleMobileSidebar);

            function closeMobileSidebar() {
                if (window.innerWidth < mobileBreakpoint) {
                    sidebar.classList.add('-translate-x-full');
                    pageOverlay.classList.add('opacity-0', 'pointer-events-none');
                }
            }
            
            // --- Toast Notification (REQ 2.3) ---
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast-notification');
                const toastMessage = document.getElementById('toast-message');
                const toastIcon = document.getElementById('toast-icon');
                
                toastMessage.textContent = message;
                
                // Reset classes
                toast.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');
                toastIcon.className = ''; 

                if (type === 'error' || type === 'warning') {
                    toast.classList.add(type === 'error' ? 'bg-red-500' : 'bg-yellow-500');
                    toastIcon.classList.add('fa-solid', 'fa-exclamation-triangle', 'text-xl');
                } else {
                    toast.classList.add('bg-green-500');
                    toastIcon.classList.add('fa-solid', 'fa-check-circle', 'text-xl');
                }
                
                toast.classList.add('translate-x-0');
                toast.classList.remove('translate-x-[120%]');
                
                setTimeout(() => {
                    toast.classList.remove('translate-x-0');
                    toast.classList.add('translate-x-[120%]');
                }, type === 'warning' ? 4500 : 3000); // Longer duration for warning
            }

            // --- Logo Upload Logic ---
            function handleLogoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    document.getElementById('logo-preview-img').src = imageUrl;
                    document.getElementById('logo-preview-img').style.display = 'block';
                    document.querySelector('.logo-preview .placeholder').style.display = 'none';
                    document.getElementById('sidebar-logo-img').src = imageUrl;
                    localStorage.setItem('eqlm-logo', imageUrl);
                    showToast('Logo updated!');
                };
                reader.readAsDataURL(file);
            }

            function loadLogoFromStorage() {
                const savedLogo = localStorage.getItem('eqlm-logo');
                if (savedLogo) {
                    document.getElementById('sidebar-logo-img').src = savedLogo;
                    const previewImg = document.getElementById('logo-preview-img');
                    if (previewImg) {
                        previewImg.src = savedLogo;
                        previewImg.style.display = 'block';
                        document.querySelector('.logo-preview .placeholder').style.display = 'none';
                    }
                }
            }

            // --- GEMINI API CALL LOGIC ---
            async function retryFetch(url, options, retries = 5, delay = 1000) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status >= 400 && response.status < 500) {
                            throw new Error(`API Client Error: ${response.status} ${response.statusText}`);
                        }
                        throw new Error(`API Server Error: ${response.status} ${response.statusText}`);
                    }
                    return response;
                } catch (err) {
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return retryFetch(url, options, retries - 1, delay * 2);
                    } else {
                        throw new Error("Max retries reached. " + err.message);
                    }
                }
            }

            async function callGeminiAPI(userPrompt, systemPrompt, resultElement, loaderElement, buttonElement, saveButton) {
                buttonElement.classList.add('loading');
                buttonElement.disabled = true;
                resultElement.value = "";
                if(saveButton) saveButton.style.display = 'none';

                const apiKey = ""; // API key is handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                try {
                    const response = await retryFetch(apiUrl, fetchOptions);
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0) {
                        const candidate = result.candidates[0];
                        if (candidate.content?.parts?.[0]?.text) {
                            const text = candidate.content.parts[0].text;
                            resultElement.value = text;
                            if(saveButton) saveButton.style.display = 'inline-flex';
                        } else {
                            throw new Error("API returned a candidate but no text content.");
                        }
                    } else if (result.error) {
                        throw new Error(result.error.message);
                    } else {
                        throw new Error("Invalid response structure or no content generated.");
                    }

                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    resultElement.value = `Error: ${error.message}\n\nPlease check your API key, network connection, and console for more details.`;
                } finally {
                    buttonElement.classList.remove('loading');
                    buttonElement.disabled = false;
                }
            }

            function handleWorkflowGeneration() {
                const promptElement = document.getElementById('workflow-prompt');
                const resultElement = document.getElementById('workflow-result');
                const buttonElement = document.getElementById('generate-workflow-btn');
                const saveButton = document.getElementById('save-workflow-btn');
                
                const userPrompt = promptElement.value;
                if (!userPrompt.trim()) {
                    showToast('Please describe the workflow goal.', 'error');
                    return;
                }
                const systemPrompt = "You are an expert in industrial plant management and quality assurance. Generate a clear, concise, step-by-step workflow based on the user's request. Format the output as a numbered list.";
                callGeminiAPI(userPrompt, systemPrompt, resultElement, null, buttonElement, saveButton);
            }

            function handleEmailGeneration() {
                const promptElement = document.getElementById('email-prompt');
                const resultElement = document.getElementById('email-result');
                const buttonElement = document.getElementById('generate-email-btn');
                const saveButton = document.getElementById('save-email-btn');

                const userPrompt = promptElement.value;
                if (!userPrompt.trim()) {
                    showToast("Please describe the email's purpose.", 'error');
                    return;
                }
                const systemPrompt = "You are a professional communications manager for an industrial plant. Write a clear and concise email template for the given purpose. The template must include a subject line (prefixed with 'Subject:') and a body. Use [BRACKETED_PLACEHOLDERS] for any dynamic content (e.g., [Plant_Name], [Test_Name], [Date]).";
                callGeminiAPI(userPrompt, systemPrompt, resultElement, null, buttonElement, saveButton);
            }
            
            // --- Save Generated Content Logic ---
            
            function handleSaveWorkflow() {
                const resultText = document.getElementById('workflow-result').value;
                if (!resultText) return;
                
                const title = resultText.split('\n')[0].replace(/^\d+\.\s*/, '') || 'Workflow';
                savedWorkflows.push({ id: Date.now(), title: title, content: resultText });
                
                renderSavedWorkflows();
                showToast('Workflow saved!');
            }
            
            function renderSavedWorkflows() {
                const list = document.getElementById('saved-workflows-list');
                const placeholder = document.getElementById('workflow-placeholder');
                if (!list) return;
                
                if (placeholder) placeholder.remove(); 
                list.innerHTML = ''; 
                
                if (savedWorkflows.length === 0) {
                    list.appendChild(placeholder);
                } else {
                    savedWorkflows.forEach(wf => {
                        const item = document.createElement('div');
                        item.className = 'saved-item bg-gray-100 border border-gray-200 rounded-lg p-4 font-medium text-sm text-gray-700';
                        item.textContent = wf.title;
                        list.appendChild(item);
                    });
                }
            }

            function handleSaveEmail() {
                const resultText = document.getElementById('email-result').value;
                if (!resultText) return;

                let subject = 'Email Template';
                let body = resultText;

                const subjectMatch = resultText.match(/Subject:(.*)/i);
                if (subjectMatch && subjectMatch[1]) {
                    subject = subjectMatch[1].trim();
                    body = resultText.substring(resultText.indexOf('\n') + 1).trim();
                }

                savedEmailTemplates.push({ id: Date.now(), subject: subject, body: body.split('\n')[0] });
                
                renderSavedEmails();
                showToast('Email template saved!');
            }
            
            function renderSavedEmails() {
                 const list = document.getElementById('saved-emails-list');
                 const placeholder = document.getElementById('email-placeholder');
                 if (!list) return;
                
                 if (placeholder) placeholder.remove();
                 list.innerHTML = ''; 
                
                 if (savedEmailTemplates.length === 0) {
                     list.appendChild(placeholder);
                 } else {
                     savedEmailTemplates.forEach(email => {
                         const item = document.createElement('div');
                         item.className = 'saved-item email bg-gray-100 border border-gray-200 rounded-lg p-4';
                         item.innerHTML = `
                             <span class="item-title block text-sm font-semibold text-gray-800 mb-1">${email.subject}</span>
                             <span class="item-body block text-sm text-gray-600 overflow-hidden text-ellipsis whitespace-nowrap">${email.body}</span>
                         `;
                         list.appendChild(item);
                     });
                 }
            }
            
            // --- Save Assign Lab Properties ---
            function handleSaveAssignLab() {
                const button = document.getElementById('save-lab-settings');
                button.classList.add('loading');
                button.disabled = true;

                // REQ 4: Get values from new fields
                const selectedLabIds = getMultiSelectValues('select-lab-options');
                const selectedPlants = document.getElementById('auto-plant').value;
                const selectedSection = document.getElementById('auto-section').value;
                const selectedBuildings = document.getElementById('auto-building').value;
                const selectedItem = document.getElementById('select-items-to-add').value;

                if (selectedLabIds.length === 0 || !selectedItem) {
                    showToast('Please select labs and an item to add.', 'error');
                    button.classList.remove('loading');
                    button.disabled = false;
                    return;
                }

                const saveData = {
                    labIds: selectedLabIds,
                    labCategory: selectedLabCategory,
                    plants: selectedPlants,
                    section: selectedSection,
                    buildingsOrGroups: selectedBuildings,
                    itemToAdd: selectedItem
                };

                console.log("Saving Lab Settings:", saveData);
                
                setTimeout(() => {
                    button.classList.remove('loading');
                    button.disabled = false;
                    showToast('Settings saved successfully!');
                }, 1500);
            }


            // --- Custom Multi-Select Dropdown Logic ---
            
            // This is a generic helper, NOT used by the new Lab Select
            function updateMultiselectText(container) {
                const options = container.querySelectorAll('.multiselect-option input[type="checkbox"]');
                const textElement = container.querySelector('.multiselect-text');
                
                const selectedOptions = Array.from(options).filter(opt => opt.checked);
                
                if (selectedOptions.length === 0) {
                    textElement.textContent = 'None selected';
                    textElement.classList.add('placeholder', 'text-gray-500');
                } else if (selectedOptions.length <= 3) {
                    textElement.textContent = selectedOptions.map(opt => opt.nextElementSibling.textContent).join(', ');
                    textElement.classList.remove('placeholder', 'text-gray-500');
                } else {
                    textElement.textContent = `${selectedOptions.length} selected`;
                    textElement.classList.remove('placeholder', 'text-gray-500');
                }
            }
            
            // Global click listener to close dropdowns
            document.addEventListener('click', (e) => {
                document.querySelectorAll('.custom-multiselect.open').forEach(dropdown => {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('open');
                    }
                });
            });

            // --- Assign Lab Properties Page Logic (REQ 2, 3, 4) ---
            
            function initializeAssignLabPage() {
                flatLabDatabase = [];
                selectedLabCategory = null; // Reset state
                
                function parseLabs(labData, plant, section, groupPath = null) {
                    Object.keys(labData).forEach(labName => {
                        if (labData[labName].labs) {
                            const newGroupPath = groupPath ? `${groupPath} > ${labName}` : labName;
                            parseLabs(labData[labName].labs, plant, section, newGroupPath);
                        } else {
                            const pathParts = [plant, section];
                            if (groupPath) pathParts.push(groupPath);
                            pathParts.push(labName);

                            flatLabDatabase.push({
                                id: pathParts.join('_').replace(/ > /g, '_').replace(/ /g, ''), 
                                name: labName, // This is the "category"
                                plant: plant,
                                section: section,
                                buildingOrGroup: groupPath, 
                                path: `${labName} (${pathParts.join(' > ')})`
                            });
                        }
                    });
                }

                Object.keys(plantData).forEach(plantName => {
                    Object.keys(plantData[plantName]).forEach(sectionName => {
                        const section = plantData[plantName][sectionName];
                        if (Object.keys(section.buildings).length === 0 && section.labs) {
                            parseLabs(section.labs, plantName, sectionName, null);
                        }
                        if (Object.keys(section.buildings).length > 0) {
                            Object.keys(section.buildings).forEach(buildingName => {
                                const building = section.buildings[buildingName];
                                if (building.labs) {
                                    parseLabs(building.labs, plantName, sectionName, buildingName);
                                }
                            });
                        }
                    });
                });
                
                // REQ 2.1: Populate new multi-select
                const labOptionsContainer = document.getElementById('select-lab-options');
                labOptionsContainer.innerHTML = '';
                const uniqueLabs = [...new Map(flatLabDatabase.map(lab => [lab.path, lab])).values()];
                uniqueLabs.sort((a,b) => a.path.localeCompare(b.path));
                
                uniqueLabs.forEach(lab => {
                    const optionHTML = `
                        <label class="multiselect-option flex items-center p-3 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer" 
                               data-category="${lab.name}" 
                               data-lab-id="${lab.id}">
                            <input type="checkbox" value="${lab.id}" class="mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span>${lab.path}</span>
                        </label>
                    `;
                    labOptionsContainer.insertAdjacentHTML('beforeend', optionHTML);
                });

                // Add listeners to new lab checkboxes
                labOptionsContainer.querySelectorAll('.multiselect-option').forEach(el => {
                    // Use 'click' on the label to handle prevention
                    el.addEventListener('click', handleLabSelection, true); 
                });
                
                initializeMultiSelect(document.getElementById('select-lab-wrapper'), true); // Skip initial text update
                document.getElementById('select-items-to-add').addEventListener('change', onItemsChange);
            }

            // REQ 2.2: Category Matching Logic
            function handleLabSelection(e) {
                e.preventDefault(); // Manually control checkbox
                e.stopPropagation();

                const label = e.currentTarget;
                const checkbox = label.querySelector('input[type="checkbox"]');
                const clickedCategory = label.dataset.category;
                
                // Case 1: Trying to check a new box
                if (!checkbox.checked) {
                    if (selectedLabCategory === null) {
                        // First selection, set the category
                        selectedLabCategory = clickedCategory;
                        checkbox.checked = true;
                    } else if (clickedCategory === selectedLabCategory) {
                        // Category matches, allow selection
                        checkbox.checked = true;
                    } else {
                        // REQ 2.3: Category mismatch, show toast
                        showToast(`Please select labs from the "${selectedLabCategory}" category.`, 'warning');
                        return; // Do not check the box
                    }
                } 
                // Case 2: Trying to uncheck a box
                else {
                    checkbox.checked = false;
                }
                
                const newSelectedOptions = getMultiSelectValues('select-lab-options');
                
                // Case 3: Just unchecked the last box
                if (newSelectedOptions.length === 0) {
                    selectedLabCategory = null;
                    // Re-enable all options
                    document.querySelectorAll('#select-lab-options .multiselect-option').forEach(opt => {
                        opt.classList.remove('disabled');
                        opt.querySelector('input').disabled = false;
                    });
                } else {
                    // Filter options based on the locked-in category
                    document.querySelectorAll('#select-lab-options .multiselect-option').forEach(opt => {
                        if (opt.dataset.category !== selectedLabCategory) {
                            opt.classList.add('disabled');
                            opt.querySelector('input').disabled = true;
                        } else {
                            opt.classList.remove('disabled');
                            opt.querySelector('input').disabled = false;
                        }
                    });
                }
                
                updateLabMultiselectText(); // REQ 3
                populateReadOnlyFields(); // REQ 4
            }

            // REQ 3: Custom Placeholder
            function updateLabMultiselectText() {
                const wrapper = document.getElementById('select-lab-wrapper');
                const textElement = wrapper.querySelector('.multiselect-text');
                const selectedOptions = getMultiSelectValues('select-lab-options');
                
                if (selectedOptions.length === 0) {
                    textElement.textContent = 'Select Lab(s)';
                    textElement.classList.add('placeholder', 'text-gray-500');
                } else {
                    textElement.textContent = `${selectedLabCategory} (${selectedOptions.length} location${selectedOptions.length > 1 ? 's' : ''})`;
                    textElement.classList.remove('placeholder', 'text-gray-500');
                }
            }

            // REQ 4: Auto-Populate Read-Only Fields
            function populateReadOnlyFields() {
                const selectedLabIds = getMultiSelectValues('select-lab-options');
                const plantInput = document.getElementById('auto-plant');
                const sectionInput = document.getElementById('auto-section');
                const buildingInput = document.getElementById('auto-building');
                
                if (selectedLabIds.length === 0) {
                    plantInput.value = '';
                    sectionInput.value = '';
                    buildingInput.value = '';
                    resetDropdown('select-items-to-add', 'Select');
                    return;
                }
                
                const plants = new Set();
                const sections = new Set();
                const buildings = new Set();

                const selectedLabs = flatLabDatabase.filter(lab => selectedLabIds.includes(lab.id));
                
                selectedLabs.forEach(lab => {
                    plants.add(lab.plant);
                    sections.add(lab.section);
                    if (lab.buildingOrGroup) {
                        buildings.add(lab.buildingOrGroup);
                    }
                });
                
                plantInput.value = [...plants].join(', ') || 'N/A';
                sectionInput.value = [...sections].join(', ') || 'N/A';
                buildingInput.value = [...buildings].join(', ') || 'N/A';
                
                // Enable the final "Items to Add" dropdown
                document.getElementById('select-items-to-add').disabled = false;
            }

            function onItemsChange() {
                // Logic when "Items to Add" is changed
            }

            // --- Multi-Select Helper Functions ---
            function initializeMultiSelect(container, skipInitialTextUpdate = false) {
                if (!container) return;
                const display = container.querySelector('.multiselect-display');
                
                display.addEventListener('click', (e) => {
                    if (container.classList.contains('disabled')) return;
                    e.stopPropagation();
                    
                    document.querySelectorAll('.custom-multiselect.open').forEach(openDropdown => {
                        if (openDropdown !== container) {
                            openDropdown.classList.remove('open');
                        }
                    });
                    container.classList.toggle('open');
                });
                
                if (!skipInitialTextUpdate) {
                    updateMultiselectText(container);
                }
            }
            
            function getMultiSelectValues(optionsContainerId) {
                return Array.from(document.querySelectorAll(`#${optionsContainerId} input[type="checkbox"]:checked`))
                    .map(cb => cb.value);
            }

            function resetDropdown(selectId, placeholderText) {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = `<option value="" selected>${placeholderText}</option>`;
                    select.disabled = true;
                }
            }

            // --- Initial Load ---
            loadLogoFromStorage(); 
            loadPage('Plant Dashboard', dashboardContent, 'dashboard');
            
            // Set initial sidebar state based on screen size
            if (window.innerWidth < mobileBreakpoint) {
                // Mobile: start hidden
                sidebar.classList.add('-translate-x-full');
            } else {
                // Desktop: start collapsed
                sidebar.classList.remove('-translate-x-full');
                toggleDesktopSidebar(); // Start collapsed
            }
            sidebar.style.visibility = 'visible';

        });
    </script>
</body>
</html>